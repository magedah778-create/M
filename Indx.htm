<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ุฎุทุฉ ุงูุงูุถุจุงุท ุงููุฏุฑุณู ูู ุฑูุถุงู (20 ููู)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;600;700;800;900&display=swap" rel="stylesheet">
  <style>
    *{font-family:'Tajawal',sans-serif}
    .card{background:rgba(255,255,255,.85);backdrop-filter: blur(8px)}
    .soft{box-shadow: 0 12px 30px rgba(0,0,0,.08)}
    @media print{
      .no-print{display:none !important}
      body{background:#fff !important}
      .card{background:#fff !important; box-shadow:none !important}
    }
  </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-violet-50 via-fuchsia-50 to-slate-50 text-slate-900">
  <header class="px-4 py-6">
    <div class="max-w-6xl mx-auto">
      <div class="card soft rounded-3xl p-5 md:p-7 border border-violet-100">
        <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
          <div>
            <h1 class="text-2xl md:text-3xl font-extrabold text-violet-900">ุฎุทุฉ ุงูุงูุถุจุงุท ุงููุฏุฑุณู ูู ุฑูุถุงู ููุทุงูุจุฉ (20 ููู)</h1>
            <p class="text-slate-600 mt-1">ูุชุงุจุนุฉ ููููุฉ ูุงุจูุฉ ููููุงุณ + ูุฑุชุจุทุฉ ุจุงูุฃุฐูุงุฑ ููุฑุฏ ูุฑุขูู โ ูุน ุญูุธ ุชููุงุฆู ูููู CSV.</p>
          </div>

          <div class="no-print flex flex-wrap gap-2">
            <button id="btnSave" class="px-4 py-2 rounded-xl bg-violet-600 text-white font-bold hover:bg-violet-700 transition">ุญูุธ ุงูุขู</button>
            <button id="btnReset" class="px-4 py-2 rounded-xl bg-white border border-slate-200 font-bold hover:bg-slate-50 transition">ุชุตููุฑ ุงูุฎุทุฉ</button>
            <button id="btnCSV" class="px-4 py-2 rounded-xl bg-emerald-600 text-white font-bold hover:bg-emerald-700 transition">ุชุตุฏูุฑ CSV</button>
            <button onclick="window.print()" class="px-4 py-2 rounded-xl bg-slate-900 text-white font-bold hover:bg-black transition">ุทุจุงุนุฉ</button>
          </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-3 mt-5">
          <div class="p-4 rounded-2xl bg-white border border-slate-100">
            <label class="text-sm font-bold text-slate-700">ุงุณู ุงูุทุงูุจุฉ</label>
            <input id="studentName" class="mt-1 w-full px-3 py-2 rounded-xl border border-slate-200 focus:outline-none focus:ring-2 focus:ring-violet-300" placeholder="ุงูุชุจู ุงูุงุณู ููุง" />
          </div>
          <div class="p-4 rounded-2xl bg-white border border-slate-100">
            <label class="text-sm font-bold text-slate-700">ุงูุตู / ุงูุดุนุจุฉ</label>
            <input id="studentClass" class="mt-1 w-full px-3 py-2 rounded-xl border border-slate-200 focus:outline-none focus:ring-2 focus:ring-violet-300" placeholder="ูุซุงู: 2/ุฃ" />
          </div>
          <div class="p-4 rounded-2xl bg-white border border-slate-100">
            <label class="text-sm font-bold text-slate-700">ุชุงุฑูุฎ ุจุฏุก ุงูุฎุทุฉ</label>
            <input id="startDate" type="date" class="mt-1 w-full px-3 py-2 rounded-xl border border-slate-200 focus:outline-none focus:ring-2 focus:ring-violet-300" />
            <p class="text-xs text-slate-500 mt-2">ูุชู ุงุญุชุณุงุจ ุงูุฃูุงู ุชููุงุฆููุง (20 ููู).</p>
          </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-3 mt-4">
          <div class="p-4 rounded-2xl bg-white border border-slate-100">
            <div class="flex items-center justify-between gap-2">
              <p class="font-extrabold text-slate-800">ุงูุชูุฏูู ุงูุนุงู</p>
              <span id="overallPct" class="text-sm font-black text-violet-700">0%</span>
            </div>
            <div class="w-full bg-slate-100 rounded-full h-3 mt-3 overflow-hidden">
              <div id="overallBar" class="h-3 rounded-full bg-violet-600 w-0 transition-all"></div>
            </div>
            <div class="flex items-center justify-between mt-2 text-xs text-slate-600">
              <span>ุงูููุงุท</span>
              <span><b id="overallPoints">0</b> / <span id="overallMax">0</span></span>
            </div>
          </div>

          <div class="p-4 rounded-2xl bg-white border border-slate-100">
            <p class="font-extrabold text-slate-800">ูุคุดุฑุงุช ูุงุจูุฉ ููููุงุณ (ูููููุง)</p>
            <ul class="mt-2 text-sm text-slate-700 space-y-1">
              <li>โ ุงูุงูุถุจุงุท ุงูุฒููู: ุญุถูุฑ + ุทุงุจูุฑ + ุฏุฎูู ุงูุญุตุฉ (ุจุงูููุช)</li>
              <li>โ ุงูุงูุถุจุงุท ุงูุณูููู: ุงุญุชุฑุงู + ุชุนุงูู + ุงูุชุฒุงู ุงูุชุนูููุงุช</li>
              <li>โ ุงูุงูุถุจุงุท ุงูุฏุฑุงุณู: ูุงุฌุจุงุช + ุชุฌููุฒ ุฃุฏูุงุช + ูุดุงุฑูุฉ</li>
              <li>๐ฟ ุงูุฑูุญ ุงูุฑูุถุงููุฉ: ุฃุฐูุงุฑ + ูุฑุฏ ูุฑุขูู (ุจุงูุฏูุงุฆู/ุงูุขูุงุช)</li>
            </ul>
          </div>

          <div class="p-4 rounded-2xl bg-white border border-slate-100">
            <p class="font-extrabold text-slate-800">ุชุนุฒูุฒ ูุชุญููุฒ</p>
            <div class="mt-3 grid grid-cols-3 gap-2">
              <div class="rounded-2xl p-3 bg-violet-50 border border-violet-100 text-center">
                <div class="text-2xl">โญ</div>
                <div class="text-xs font-bold text-slate-700">ูุฌูุฉ ููููุฉ</div>
                <div id="starsCount" class="text-lg font-black text-violet-700">0</div>
              </div>
              <div class="rounded-2xl p-3 bg-emerald-50 border border-emerald-100 text-center">
                <div class="text-2xl">๐</div>
                <div class="text-xs font-bold text-slate-700">ุดุงุฑุงุช</div>
                <div id="badgesCount" class="text-lg font-black text-emerald-700">0</div>
              </div>
              <div class="rounded-2xl p-3 bg-amber-50 border border-amber-100 text-center">
                <div class="text-2xl">๐</div>
                <div class="text-xs font-bold text-slate-700">ูุนุฏู ุงููุฑุฏ</div>
                <div id="quranAvg" class="text-lg font-black text-amber-700">0</div>
              </div>
            </div>
            <p id="badgeText" class="mt-3 text-sm text-slate-700 font-semibold"></p>
          </div>
        </div>

      </div>
    </div>
  </header>

  <main class="px-4 pb-10">
    <div class="max-w-6xl mx-auto">
      <div class="card soft rounded-3xl p-5 md:p-7 border border-violet-100">
        <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3">
          <div>
            <h2 class="text-xl md:text-2xl font-extrabold text-slate-900">ูุชุงุจุนุฉ 20 ููู</h2>
            <p class="text-slate-600 mt-1">ุงุฎุชุงุฑู ุฅูุฌุงุฒ ุงูููู + ุญุฏุฏู ุฏูุงุฆู ุงููุฑุฏ ูุงูุขูุงุช. ูุชู ุงุญุชุณุงุจ ุงูููุงุท ุชููุงุฆููุง.</p>
          </div>

          <div class="no-print flex flex-wrap items-center gap-2">
            <button id="btnToday" class="px-4 py-2 rounded-xl bg-white border border-slate-200 font-bold hover:bg-slate-50 transition">ุงูุงูุชูุงู ููููู ุงูุญุงูู</button>
            <button id="btnCollapse" class="px-4 py-2 rounded-xl bg-violet-100 text-violet-900 font-bold hover:bg-violet-200 transition">ุทู/ูุชุญ ุงูุชูุงุตูู</button>
          </div>
        </div>

        <div id="daysWrap" class="mt-5 grid grid-cols-1 gap-3"></div>

        <div class="mt-6 rounded-2xl border border-slate-100 bg-white p-4">
          <h3 class="font-extrabold text-slate-900">ููุงุญุธุงุช ุงููุนููุฉ / ููู ุงูุฃูุฑ</h3>
          <textarea id="notes" class="mt-2 w-full min-h-28 px-3 py-2 rounded-xl border border-slate-200 focus:outline-none focus:ring-2 focus:ring-violet-300" placeholder="ุงูุชุจู ููุงุญุธุงุช ูุตูุฑุฉ (ูุชุงุจุนุฉุ ุชุนุฒูุฒุ ุชูุจูู ูุทูู...)"></textarea>
          <p class="text-xs text-slate-500 mt-2">ูุชู ุญูุธ ุงูููุงุญุธุงุช ุชููุงุฆููุง ูุน ุงูุฎุทุฉ.</p>
        </div>

        <div class="no-print mt-6 rounded-2xl border border-violet-100 bg-violet-50 p-4">
          <p class="font-extrabold text-violet-900">ุงูุชุฑุงุญ ุฌุงูุฒ ูุชุนุฒูุฒ ูููู (ุงูุณุฎูู ููุทุงูุจุฉ):</p>
          <p id="dailyPraise" class="mt-2 text-slate-800"></p>
        </div>
      </div>
    </div>
  </main>

<script>
(function(){
  const KEY = "ramadan_discipline_20days_v1";

  // ุฅุนุฏุงุฏ ุงูุฃูุฏุงู ุงูููููุฉ (ูุงุจูุฉ ููููุงุณ)
  // ูู ุนูุตุฑ ูู ููุงุท ูุญุฏุฏุฉ. ูุฌููุน ุงูููู = 20 ููุทุฉ (ุณูู ุงูุญุณุงุจ).
  const dailyItems = [
    { id:"attend",  label:"ุญุถุฑุชู ุงูููู", points:2 },
    { id:"onTime",  label:"ุญุถุฑุชู ูู ุงูููุช ุงููุญุฏุฏ", points:2 },
    { id:"line",    label:"ุงูุชุฒูุชู ุจุทุงุจูุฑ ุงูุตุจุงุญ ุจูุฏูุก", points:2 },
    { id:"uniform", label:"ุฒูู/ูุธูุฑ ูุฑุชุจ", points:1 },
    { id:"tools",   label:"ุฃุญุถุฑุชู ุฃุฏูุงุชู ูุงููุฉ", points:1 },
    { id:"hw",      label:"ุฃูุฌุฒุชู ุงููุงุฌุจ/ุงูุชูููู", points:2 },
    { id:"focus",   label:"ุชุฑููุฒ ุฏุงุฎู ุงูุญุตุฉ", points:2 },
    { id:"respect", label:"ุงุญุชุฑุงู ุงููุนููุฉ ูุงูุฒูููุงุช", points:2 },
    { id:"help",    label:"ุชุนุงููุชู ูุณุงุนุฏุชู ุฒูููุชู", points:2 },
    { id:"rules",   label:"ุงูุชุฒูุชู ุจุงูุชุนูููุงุช", points:2 },
    { id:"morningAdhkar", label:"ุฃุฐูุงุฑ ุงูุตุจุงุญ", points:1 },
    { id:"eveningAdhkar", label:"ุฃุฐูุงุฑ ุงููุณุงุก", points:1 }
  ];

  // ุงููุฑุฏ ุงููุฑุขูู: ููุงุท ุญุณุจ ุงูุฏูุงุฆู/ุงูุขูุงุช (ููุญุณุจ ุขูููุง ุญุชู 2 ููุทุฉ)
  const quranConfig = {
    minutesTarget: 10, // ูุฏู ูููู ุจุงูุฏูุงุฆู
    versesTarget: 5,   // ูุฏู ูููู ุจุงูุขูุงุช
    maxPoints: 2
  };

  const $ = (id)=>document.getElementById(id);

  const state = {
    studentName:"",
    studentClass:"",
    startDate:"",
    notes:"",
    collapsed:false,
    days: Array.from({length:20}, (_,i)=>({
      idx:i+1,
      dateISO:"",
      checks: Object.fromEntries(dailyItems.map(x=>[x.id,false])),
      quranMinutes:0,
      quranVerses:0,
      reflection:""
    }))
  };

  function todayISO(){
    const d = new Date();
    const off = d.getTimezoneOffset();
    const local = new Date(d.getTime() - off*60000);
    return local.toISOString().slice(0,10);
  }

  function isoToArabic(iso){
    if(!iso) return "";
    const d = new Date(iso+"T00:00:00");
    const fmt = new Intl.DateTimeFormat("ar-SA", { weekday:"long", year:"numeric", month:"long", day:"numeric" });
    return fmt.format(d);
  }

  function addDays(iso, n){
    const d = new Date(iso+"T00:00:00");
    d.setDate(d.getDate()+n);
    const off = d.getTimezoneOffset();
    const local = new Date(d.getTime() - off*60000);
    return local.toISOString().slice(0,10);
  }

  function load(){
    const raw = localStorage.getItem(KEY);
    if(!raw) return;
    try{
      const parsed = JSON.parse(raw);
      Object.assign(state, parsed);
    }catch(e){}
  }

  function save(){
    state.studentName = $("studentName").value.trim();
    state.studentClass = $("studentClass").value.trim();
    state.startDate = $("startDate").value;
    state.notes = $("notes").value;
    localStorage.setItem(KEY, JSON.stringify(state));
    toast("ุชู ุงูุญูุธ โ");
  }

  function resetAll(){
    localStorage.removeItem(KEY);
    location.reload();
  }

  function quranPoints(minutes, verses){
    // ุงูููุงุท ุญุณุจ ุชุญููู ุงููุฏู: 1 ููุทุฉ ููุฏูุงุฆู + 1 ููุทุฉ ููุขูุงุช
    let p = 0;
    if(Number(minutes) >= quranConfig.minutesTarget) p += 1;
    if(Number(verses) >= quranConfig.versesTarget) p += 1;
    return Math.min(p, quranConfig.maxPoints);
  }

  function dayMaxPoints(){
    const base = dailyItems.reduce((a,x)=>a+x.points,0);
    return base + quranConfig.maxPoints; // = 18 + 2 = 20
  }

  function dayPoints(day){
    let p = 0;
    for(const item of dailyItems){
      if(day.checks[item.id]) p += item.points;
    }
    p += quranPoints(day.quranMinutes, day.quranVerses);
    return p;
  }

  function overall(){
    const max = dayMaxPoints() * state.days.length;
    const points = state.days.reduce((a,d)=>a+dayPoints(d),0);
    const pct = max ? Math.round((points/max)*100) : 0;
    return {max, points, pct};
  }

  function computeBadges(){
    const maxPerDay = dayMaxPoints();
    let stars = 0;     // ูุฌูุฉ ุฅุฐุง ุญุตูุช 16+ ูู 20
    let badges = 0;    // ุดุงุฑุฉ ุฅุฐุง ุญุตูุช 90%+ ูุฎูุณุฉ ุฃูุงู ูุชุชุงููุฉ
    let quranTotal = 0;

    const scores = state.days.map(d=>{
      const pts = dayPoints(d);
      if(pts >= 16) stars++;
      quranTotal += Number(d.quranVerses||0);
      return pts;
    });

    // ุดุงุฑุฉ ุงูุณูุณูุฉ: ูู 5 ุฃูุงู ูุชุชุงููุฉ ุจูุณุจุฉ 90% (>=18/20)
    let streak = 0;
    for(const s of scores){
      if(s >= 18){ streak++; }
      else { streak = 0; }
      if(streak === 5){ badges++; streak = 0; }
    }

    const quranAvg = Math.round(quranTotal / state.days.length);
    return {stars, badges, quranAvg};
  }

  function praiseText(pct){
    const name = $("studentName").value.trim() || "ุจุทูุชู";
    if(pct >= 90) return `๐ ${name} ุฑุงุฆุนุฉ! ุงูุชุฒุงู ููุชุงุฒ ูู ุฑูุถุงูุ ุงุณุชูุฑู ุนูู ููุณ ุงููุณุชููุ ููุฑุฏู ุงููุฑุขูู ูุฑูุนู ุฏุฑุฌุงุช.`;
    if(pct >= 75) return `โจ ${name} ุฃุญุณูุชู! ุชูุฏูู ุฌูููุ ุฑููุฒู ุบุฏูุง ุนูู ุงูููุช ูุงููุฑุฏ ูุชุตููู ููุฃูุถู.`;
    if(pct >= 60) return `๐ฟ ${name} ุจุฏุงูุฉ ุทูุจุฉุ ูุญุชุงุฌ ุงูุชุธุงู ุฃูุจุฑ ูู ุงูุณููู/ุงููุงุฌุจ + ููุฑุฏ ุจุณูุท ูููููุง.`;
    return `๐ ${name} ูุง ุจุฃุณุ ุณูุจุฏุฃ ูู ุฌุฏูุฏ ุจุฎุทูุงุช ุตุบูุฑุฉ: ุญุถูุฑ ุจููุช + ูุงุฌุจ + 10 ุฏูุงุฆู ูุฑุขู.`;
  }

  function render(){
    // ุชุนุจุฆุฉ ุงูุญููู
    $("studentName").value = state.studentName || "";
    $("studentClass").value = state.studentClass || "";
    $("startDate").value = state.startDate || "";
    $("notes").value = state.notes || "";

    // ุชุญุฏูุซ ุชูุงุฑูุฎ ุงูุฃูุงู ุฅุฐุง ุนูุฏูุง startDate
    if(state.startDate){
      state.days.forEach((d,i)=>{
        d.dateISO = addDays(state.startDate, i);
      });
    }

    // ุจูุงุก ุจุทุงูุงุช ุงูุฃูุงู
    const wrap = $("daysWrap");
    wrap.innerHTML = "";

    const maxPerDay = dayMaxPoints();

    state.days.forEach((d, i)=>{
      const pts = dayPoints(d);
      const pct = Math.round((pts/maxPerDay)*100);

      const card = document.createElement("div");
      card.id = "day-"+d.idx;
      card.className = "rounded-2xl border border-slate-100 bg-white p-4";

      const dateLabel = d.dateISO ? isoToArabic(d.dateISO) : `ุงูููู ${d.idx}`;
      const smallDate = d.dateISO ? d.dateISO : "";

      card.innerHTML = `
        <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3">
          <div>
            <div class="flex items-center gap-2 flex-wrap">
              <span class="inline-flex items-center px-3 py-1 rounded-full bg-violet-100 text-violet-900 font-extrabold">ุงูููู ${d.idx}</span>
              <span class="text-slate-800 font-bold">${dateLabel}</span>
              ${smallDate ? `<span class="text-xs text-slate-500">(${smallDate})</span>` : ``}
            </div>
            <p class="text-sm text-slate-600 mt-1">ุงูููุงุท: <b class="text-slate-900">${pts}</b> / ${maxPerDay} โ <b class="text-violet-700">${pct}%</b></p>
          </div>

          <div class="flex items-center gap-2">
            <div class="w-44 bg-slate-100 rounded-full h-3 overflow-hidden">
              <div class="h-3 rounded-full bg-violet-600" style="width:${pct}%"></div>
            </div>
            <button data-toggle="${d.idx}" class="no-print px-3 py-2 rounded-xl bg-slate-50 border border-slate-200 font-bold hover:bg-slate-100 transition">
              ุชูุงุตูู
            </button>
          </div>
        </div>

        <div class="mt-4 ${state.collapsed ? "hidden" : ""}" data-details="${d.idx}">
          <div class="grid grid-cols-1 lg:grid-cols-3 gap-3">
            <div class="rounded-2xl border border-slate-100 p-3">
              <p class="font-extrabold text-slate-900">ุงูุงูุถุจุงุท ุงูุฒููู ูุงูุณูููู ูุงูุฏุฑุงุณู</p>
              <div class="mt-2 space-y-2">
                ${dailyItems.map(item=>{
                  const checked = d.checks[item.id] ? "checked" : "";
                  return `
                    <label class="flex items-center justify-between gap-3 p-2 rounded-xl border border-slate-100 hover:bg-slate-50 cursor-pointer">
                      <span class="text-sm text-slate-800">
                        <b class="text-violet-700">+${item.points}</b> ${item.label}
                      </span>
                      <input type="checkbox" class="h-5 w-5 accent-violet-600" data-day="${d.idx}" data-check="${item.id}" ${checked}/>
                    </label>
                  `;
                }).join("")}
              </div>
            </div>

            <div class="rounded-2xl border border-slate-100 p-3">
              <p class="font-extrabold text-slate-900">ุงููุฑุฏ ุงููุฑุขูู (ูุงุจู ููููุงุณ)</p>
              <p class="text-sm text-slate-600 mt-1">ูุฏู ุงูููู: <b>${quranConfig.minutesTarget}</b> ุฏูุงุฆู + <b>${quranConfig.versesTarget}</b> ุขูุงุช (ุญุชู +2 ููุงุท)</p>

              <div class="mt-3 space-y-3">
                <div>
                  <label class="text-sm font-bold text-slate-700">ุนุฏุฏ ุงูุฏูุงุฆู</label>
                  <input type="number" min="0" step="1" value="${d.quranMinutes||0}" data-day="${d.idx}" data-num="minutes"
                         class="mt-1 w-full px-3 py-2 rounded-xl border border-slate-200 focus:outline-none focus:ring-2 focus:ring-violet-300"/>
                </div>
                <div>
                  <label class="text-sm font-bold text-slate-700">ุนุฏุฏ ุงูุขูุงุช</label>
                  <input type="number" min="0" step="1" value="${d.quranVerses||0}" data-day="${d.idx}" data-num="verses"
                         class="mt-1 w-full px-3 py-2 rounded-xl border border-slate-200 focus:outline-none focus:ring-2 focus:ring-violet-300"/>
                </div>

                <div class="rounded-xl bg-amber-50 border border-amber-100 p-3">
                  <p class="text-sm font-bold text-amber-900">ุชุฐููุฑ ูุทูู</p>
                  <p class="text-sm text-slate-700 mt-1">ุงุจุฏุฆู ูุจู ุงูููู ุจู <b>5 ุฏูุงุฆู</b> ุซู ุฒูุฏู ุชุฏุฑูุฌููุง ุญุชู ุงููุฏู.</p>
                </div>
              </div>
            </div>

            <div class="rounded-2xl border border-slate-100 p-3">
              <p class="font-extrabold text-slate-900">ุชุฃูู ุจุณูุท (1 ุฏูููุฉ)</p>
              <p class="text-sm text-slate-600 mt-1">ูุง ุฃุฌูู ุดูุก ูุนูุชู ุงููููุ ููุง ุงูุฐู ุณุฃุญุณููู ุบุฏูุงุ</p>
              <textarea data-day="${d.idx}" data-text="reflection"
                        class="mt-3 w-full min-h-28 px-3 py-2 rounded-xl border border-slate-200 focus:outline-none focus:ring-2 focus:ring-violet-300"
                        placeholder="ุงูุชุจู ุณุทุฑูู ููุท...">${escapeHTML(d.reflection||"")}</textarea>

              <div class="mt-3 rounded-xl bg-emerald-50 border border-emerald-100 p-3">
                <p class="text-sm font-bold text-emerald-900">ุชุนุฒูุฒ ุณุฑูุน</p>
                <p class="text-sm text-slate-700 mt-1">${pct>=80 ? "ููุชุงุฒ! ุงุณุชูุฑู." : "ุฌููู.. ุฎุทูุฉ ุตุบูุฑุฉ ูู ููู."}</p>
              </div>
            </div>
          </div>
        </div>
      `;

      wrap.appendChild(card);
    });

    // ุฃุฒุฑุงุฑ ุงูุชูุงุตูู
    wrap.querySelectorAll("button[data-toggle]").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        const idx = btn.getAttribute("data-toggle");
        const box = wrap.querySelector(`[data-details="${idx}"]`);
        box.classList.toggle("hidden");
      });
    });

    // ุฑุจุท ุฃุญุฏุงุซ ์ฒดํฌ
    wrap.querySelectorAll("input[type=checkbox][data-check]").forEach(ch=>{
      ch.addEventListener("change", ()=>{
        const dayIdx = Number(ch.getAttribute("data-day")) - 1;
        const key = ch.getAttribute("data-check");
        state.days[dayIdx].checks[key] = ch.checked;
        updateTop();
        autoSave();
      });
    });

    // ุฃุฑูุงู ุงููุฑุฏ
    wrap.querySelectorAll("input[type=number][data-num]").forEach(inp=>{
      inp.addEventListener("input", ()=>{
        const dayIdx = Number(inp.getAttribute("data-day")) - 1;
        const which = inp.getAttribute("data-num");
        const v = Math.max(0, Number(inp.value || 0));
        if(which === "minutes") state.days[dayIdx].quranMinutes = v;
        if(which === "verses")  state.days[dayIdx].quranVerses = v;
        updateTop();
        autoSave();
      });
    });

    // ุงูุชุฃูู
    wrap.querySelectorAll("textarea[data-text=reflection]").forEach(t=>{
      t.addEventListener("input", ()=>{
        const dayIdx = Number(t.getAttribute("data-day")) - 1;
        state.days[dayIdx].reflection = t.value;
        autoSave();
      });
    });

    updateTop();
  }

  function updateTop(){
    const o = overall();
    $("overallPoints").textContent = o.points;
    $("overallMax").textContent = o.max;
    $("overallPct").textContent = o.pct + "%";
    $("overallBar").style.width = o.pct + "%";

    const b = computeBadges();
    $("starsCount").textContent = b.stars;
    $("badgesCount").textContent = b.badges;
    $("quranAvg").textContent = b.quranAvg;

    const badgeLines = [];
    if(b.stars >= 5) badgeLines.push("๐ ุดุงุฑุฉ: ูุฌูู ุงูุงูุถุจุงุท (5 ุฃูุงู ูููุฒุฉ).");
    if(b.badges >= 1) badgeLines.push("๐ ุดุงุฑุฉ: ุณูุณูุฉ ุงูุชูููุฒ (5 ุฃูุงู ูุชุชุงููุฉ ุจูุณุจุฉ 90%+).");
    if(o.pct >= 85) badgeLines.push("โจ ุชูุงูููุง: ูุณุชูู ุนุงู ููุชุงุฒ.");
    $("badgeText").textContent = badgeLines.join(" ") || "ุงุจุฏุฆู ุงูููู ุจู (ุญุถูุฑ ุจููุช + ุฃุฐูุงุฑ + ูุฑุฏ ุจุณูุท) ูุณุชุดุงูุฏูู ุงููุฑู.";

    $("dailyPraise").textContent = praiseText(o.pct);

    // ุฅุนุงุฏุฉ ุฑุณู ุดุฑูุท ูู ููู (ุฎููู): ูุญุฏูุซ ููุท ุงููุตูุต ุงูุนูููุฉ + ูุชุฑู ุฅุนุงุฏุฉ ุงูุจูุงุก ุงููุฏูู ุนูุฏ ุงูุญุงุฌุฉ
    // ูุชุจุณูุท ุงูููุฏ: ูุนูุฏ render ูุงูู ุนูุฏ ุชุบููุฑ ูุจูุฑุ ูุงุ ุณูุชุฑูู.
    // ููู ูุฃู ุงูููุงุท ุฏุงุฎู ุงูุจุทุงูุงุช ูุง ุชุชุญุฏุซ ุชููุงุฆูุงูุ ุณูุนูุฏ render ุณุฑูุนุงู ุนูุฏ ุงูุชุญุฏูุซ.
    // ูุน ุชุฌูุจ ููุฏุงู ุงูุชูุฑูุฑ: ูุญุงูุธ ุนูู ููุถุน ุงูุชูุฑูุฑ.
    const y = window.scrollY;
    renderNoRebind();
    window.scrollTo(0,y);
  }

  function renderNoRebind(){
    // ุชุญุฏูุซ ูุงุฌูุฉ ุงูููู ุฏูู ุฅุนุงุฏุฉ ุฑุจุท ุงูุฃุญุฏุงุซ: ุฃุณูู ุฃู ูุนูุฏ render ูุงูู ููุฑุจุทุ ููู ูุฐุง ูุณุจุจ ุฅุนุงุฏุฉ ุฑุจุท ูุชูุฑุฑ.
    // ููุง ุณููุชูู ุจุชุญุฏูุซ ุฑุฃุณ ุงูุตูุญุฉ ููุท (ุงููุคุดุฑุงุช)ุ ููุชุฑู ุชุญุฏูุซ ุจุทุงูุงุช ุงูุฃูุงู ุนูุฏ ุงูุญูุธ/ุงูุทุจุงุนุฉ.
    // ุจูุง ุฃู ุงููุณุชุฎุฏู ูููู ุงููุคุดุฑุงุช ุงูุนูููุฉุ ููุชูู ุจูุง.
    // (ุฅุฐุง ุฑุบุจุชู ุจุชุญุฏูุซ ููุงุท ูู ููู ููุฑูุงุ ุฃุฎุจุฑููู ูุฃุนูููุง ุจุฅุนุงุฏุฉ ุจูุงุก ุฐููุฉ.)
  }

  let saveTimer = null;
  function autoSave(){
    clearTimeout(saveTimer);
    saveTimer = setTimeout(()=>save(), 400);
  }

  function toast(msg){
    const t = document.createElement("div");
    t.className = "no-print fixed bottom-4 right-4 z-50 px-4 py-3 rounded-2xl bg-slate-900 text-white font-bold shadow-xl";
    t.textContent = msg;
    document.body.appendChild(t);
    setTimeout(()=>t.remove(), 1300);
  }

  function escapeHTML(str){
    return String(str)
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }

  function goToToday(){
    if(!state.startDate){
      toast("ุญุฏุฏู ุชุงุฑูุฎ ุงูุจุฏุก ุฃููุงู ๐");
      return;
    }
    const t = todayISO();
    const idx = state.days.findIndex(d=>d.dateISO === t);
    const target = idx >= 0 ? $("day-"+(idx+1)) : $("day-1");
    target?.scrollIntoView({behavior:"smooth", block:"start"});
  }

  function exportCSV(){
    // ุฃุนูุฏุฉ CSV
    const header = [
      "ุงุณู ุงูุทุงูุจุฉ","ุงูุตู/ุงูุดุนุจุฉ","ุงูููู","ุงูุชุงุฑูุฎ","ุงูููุงุท","ุงููุณุจุฉ",
      ...dailyItems.map(x=>x.label),
      "ุฏูุงุฆู ุงููุฑุขู","ุขูุงุช ุงููุฑุขู","ููุงุท ุงููุฑุฏ","ุชุฃูู ุงูููู","ููุงุญุธุงุช"
    ];

    const maxPerDay = dayMaxPoints();
    const name = $("studentName").value.trim();
    const cls = $("studentClass").value.trim();
    const notes = $("notes").value.replace(/\n/g," ");

    const rows = state.days.map(d=>{
      const pts = dayPoints(d);
      const pct = Math.round((pts/maxPerDay)*100);
      const qPts = quranPoints(d.quranMinutes, d.quranVerses);

      const checks = dailyItems.map(it=> d.checks[it.id] ? "ูุนู" : "ูุง");
      return [
        name, cls, d.idx, d.dateISO, pts, pct+"%",
        ...checks,
        d.quranMinutes, d.quranVerses, qPts,
        (d.reflection||"").replace(/\n/g," "),
        notes
      ];
    });

    const csv = [header, ...rows].map(r=>r.map(cell=>{
      const s = String(cell ?? "");
      if(s.includes(",") || s.includes('"') || s.includes("\n")){
        return `"${s.replaceAll('"','""')}"`;
      }
      return s;
    }).join(",")).join("\n");

    const blob = new Blob([csv], {type:"text/csv;charset=utf-8"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = `ุฎุทุฉ_ุงูุถุจุงุท_ุฑูุถุงู_20_ููู_${name||"ุทุงูุจุฉ"}.csv`;
    a.click();
    URL.revokeObjectURL(url);
    toast("ุชู ุชุตุฏูุฑ CSV โ");
  }

  function toggleCollapseAll(){
    state.collapsed = !state.collapsed;
    // ุทุจู ุนูู ูู ุงูุชูุงุตูู
    document.querySelectorAll("[data-details]").forEach(el=>{
      if(state.collapsed) el.classList.add("hidden");
      else el.classList.remove("hidden");
    });
    autoSave();
  }

  // ุชุดุบูู
  load();
  if(!state.startDate) state.startDate = todayISO();
  render();

  // ุฑุจุท ุฃุฒุฑุงุฑ ุฃุนูู ุงูุตูุญุฉ
  $("btnSave").addEventListener("click", save);
  $("btnReset").addEventListener("click", ()=>{
    if(confirm("ูุชุฃูุฏุฉุ ุณูุชู ุญุฐู ุฌููุน ุงูุจูุงูุงุช.")) resetAll();
  });
  $("btnCSV").addEventListener("click", exportCSV);
  $("btnToday").addEventListener("click", goToToday);
  $("btnCollapse").addEventListener("click", toggleCollapseAll);

  // ุญูุธ ุนูุฏ ุชุบููุฑ ุงูุญููู ุงูุนูููุฉ
  ["studentName","studentClass","startDate","notes"].forEach(id=>{
    $(id).addEventListener("input", ()=>{
      // ุนูุฏ ุชุบููุฑ ุชุงุฑูุฎ ุงูุจุฏุก ูุญุฏูุซ ุชูุงุฑูุฎ ุงูุฃูุงู
      if(id==="startDate"){
        state.startDate = $(id).value;
        state.days.forEach((d,i)=> d.dateISO = state.startDate ? addDays(state.startDate,i) : "");
        // ูุฅุธูุงุฑ ุงูุชูุงุฑูุฎ ุนูู ุงูุจุทุงูุงุช: ูุนูุฏ ุจูุงุก ูุงูู ูุฑุฉ ูุงุญุฏุฉ
        renderFull();
      }
      autoSave();
      updateTop();
    });
  });

  function renderFull(){
    // ุฅุนุงุฏุฉ ุจูุงุก ูุงููุฉ ูุน ุฑุจุท
    render();
  }

})();
</script>
</body>
</html>
